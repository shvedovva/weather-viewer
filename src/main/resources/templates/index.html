<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout(~{::title}, ~{::main})}">
<head>
    <title>Weather Viewer - Home</title>
</head>
<body>
<main>
    <div th:if="${user != null}">
        <!-- Search Form -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Search Location</h5>
                <form action="/locations/search" method="get">
                    <div class="input-group">
                        <input type="text" name="query" class="form-control"
                               placeholder="Enter city name..." required>
                        <button class="btn btn-primary" type="submit">Search</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Locations List -->
        <div th:if="${locations != null and !locations.isEmpty()}">
            <h3>My Locations</h3>
            <div class="row">
                <div class="col-md-6 col-lg-4 mb-3" th:each="location : ${locations}">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title" th:text="${location.displayName}"></h5>

                            <div th:if="${weatherMap != null and weatherMap[location.id] != null}"
                                 th:with="weather=${weatherMap[location.id]}">
                                <div class="weather-info">
                                    <div class="temperature">
                                            <span class="temp-value"
                                                  th:text="${#numbers.formatDecimal(weather.main.temp, 0, 'COMMA', 0, 'POINT')}">--</span>°C
                                    </div>
                                    <div class="weather-description"
                                         th:text="${weather.weather != null and !#arrays.isEmpty(weather.weather) ? weather.weather[0].description : 'No data'}"></div>
                                    <div class="weather-details">
                                        <small th:if="${weather.main != null and weather.main.feelsLike != null}">
                                            Feels like:
                                            <span th:text="${#numbers.formatDecimal(weather.main.feelsLike, 0, 'COMMA', 0, 'POINT')}"></span>°C
                                        </small><br>
                                        <small th:if="${weather.main != null and weather.main.humidity != null}">
                                            Humidity:
                                            <span th:text="${weather.main.humidity}"></span>%
                                        </small><br>
                                        <small th:if="${weather.wind != null and weather.wind.speed != null}">
                                            Wind:
                                            <span th:text="${weather.wind.speed}"></span> m/s
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <div th:unless="${weatherMap != null and weatherMap[location.id] != null}" class="text-muted">
                                Weather data unavailable
                            </div>

                            <form th:action="@{/locations/delete/{id}(id=${location.id})}"
                                  method="post" class="mt-3">
                                <button type="submit" class="btn btn-danger btn-sm"
                                        onclick="return confirm('Remove this location?')">Remove</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div th:if="${locations == null or locations.isEmpty()}" class="alert alert-info">
            <h4>No locations added yet</h4>
            <p>Search for a city and add it to your weather dashboard!</p>
        </div>
    </div>

    <div th:unless="${user != null}" class="text-center py-5">
        <h2>Welcome to Weather Viewer</h2>
        <p class="lead">Track weather in your favorite locations</p>
        <div class="mt-4">
            <a href="/auth/login" class="btn btn-primary btn-lg me-2">Login</a>
            <a href="/auth/register" class="btn btn-outline-primary btn-lg">Register</a>
        </div>
    </div>
</main>
</body>
</html>